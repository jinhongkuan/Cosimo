<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cosimo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      color: #e4e4e7;
    }
    header {
      padding: 20px 32px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 {
      font-size: 24px;
      background: linear-gradient(135deg, #818cf8, #c084fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle { font-size: 13px; color: #71717a; }
    .nav { display: flex; gap: 16px; align-items: center; }
    .nav a { color: #a1a1aa; text-decoration: none; font-size: 13px; }
    .nav a:hover { color: white; }
    .status { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #71717a; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; }
    main {
      display: flex;
      padding: 32px;
      gap: 100px;
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
    }
    .column { flex: 1; z-index: 2; }
    .column-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(129, 140, 248, 0.2);
    }
    .column-dot { width: 12px; height: 12px; border-radius: 50%; }
    .column-title { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    .column-sub { font-size: 11px; color: #71717a; font-style: italic; }
    .obj .column-dot, .obj .column-title { color: #818cf8; background: #818cf8; }
    .obj .column-title { background: none; }
    .del .column-dot, .del .column-title { color: #c084fc; background: #c084fc; }
    .del .column-title { background: none; }
    .del .column-header { border-color: rgba(192, 132, 252, 0.2); }
    .bubble {
      padding: 16px 20px;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 12px;
      backdrop-filter: blur(10px);
    }
    .bubble:hover { transform: scale(1.02); }
    .bubble.dimmed { opacity: 0.3; }
    .bubble.selected { border-color: #818cf8 !important; box-shadow: 0 0 20px rgba(129, 140, 248, 0.5); }
    .bubble-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .bubble-title { font-size: 15px; font-weight: 600; color: #f4f4f5; }
    .bubble-badge { font-size: 11px; padding: 2px 8px; border-radius: 12px; font-weight: 600; color: #1a1a2e; }
    .bubble-desc { font-size: 13px; color: #a1a1aa; line-height: 1.4; }
    .bubble-meta { margin-top: 8px; font-size: 11px; color: #71717a; }
    .bubble-blocker { color: #f87171; }
    #svg-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
    #panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.98));
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(129, 140, 248, 0.3);
      padding: 24px 32px;
      z-index: 100;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    #panel.open { transform: translateY(0); }
    .panel-inner { max-width: 1200px; margin: 0 auto; }
    .panel-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
    .panel-type { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .panel-title { font-size: 20px; font-weight: 600; color: #f4f4f5; margin-top: 4px; }
    .panel-close { background: rgba(255,255,255,0.1); border: none; border-radius: 8px; padding: 8px 12px; color: #a1a1aa; cursor: pointer; }
    .panel-desc { color: #a1a1aa; font-size: 14px; margin-bottom: 20px; line-height: 1.5; }
    .panel-section { border-top: 1px solid rgba(255,255,255,0.1); padding-top: 16px; }
    .panel-section-title { font-size: 13px; font-weight: 600; color: #71717a; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    .relationship {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      margin-bottom: 12px;
    }
    .relationship-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .relationship-type { font-size: 12px; font-weight: 600; }
    .relationship-name { font-size: 14px; font-weight: 500; color: #f4f4f5; }
    .relationship-text { font-size: 13px; color: #a1a1aa; line-height: 1.6; font-style: italic; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Cosimo</h1>
      <p class="subtitle">Bridging Goals & Actions</p>
    </div>
    <div class="nav">
      <div class="status"><div class="status-dot" id="statusDot"></div><span id="statusText">Connecting...</span></div>
      <a href="/about">About</a>
      <a href="/dashboard">Dashboard</a>
      <a href="#" id="logout">Logout</a>
    </div>
  </header>

  <main id="main">
    <svg id="svg-container"><defs>
      <linearGradient id="lineGrad" x1="0%" x2="100%"><stop offset="0%" stop-color="#818cf8" stop-opacity="0.6"/><stop offset="100%" stop-color="#c084fc" stop-opacity="0.6"/></linearGradient>
      <linearGradient id="lineGradHL" x1="0%" x2="100%"><stop offset="0%" stop-color="#818cf8"/><stop offset="100%" stop-color="#c084fc"/></linearGradient>
    </defs></svg>

    <div class="column obj">
      <div class="column-header">
        <div class="column-dot"></div>
        <span class="column-title">Objectives</span>
      </div>
      <div id="objectives"></div>
    </div>

    <div class="column del">
      <div class="column-header">
        <div class="column-dot"></div>
        <span class="column-title">Deliverables</span>
        <span class="column-sub">sorted by feasibility/impact</span>
      </div>
      <div id="deliverables"></div>
    </div>
  </main>

  <div id="panel">
    <div class="panel-inner">
      <div class="panel-header">
        <div><span class="panel-type" id="panelType"></span><h2 class="panel-title" id="panelTitle"></h2></div>
        <button class="panel-close" id="panelClose">Close</button>
      </div>
      <p class="panel-desc" id="panelDesc"></p>
      <div class="panel-section">
        <h3 class="panel-section-title">Semantic Bridge</h3>
        <div id="relationships"></div>
      </div>
    </div>
  </div>

  <!-- Passphrase Modal -->
  <div id="passphraseModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:200; align-items:center; justify-content:center;">
    <div style="background:linear-gradient(135deg, #1a1a2e, #16213e); border-radius:16px; padding:32px; max-width:400px; width:90%; border:1px solid rgba(129,140,248,0.3);">
      <h2 style="font-size:18px; color:#f4f4f5; margin-bottom:8px;">Passphrase Required</h2>
      <p style="font-size:13px; color:#a1a1aa; margin-bottom:20px;">Your data is encrypted. Enter your passphrase to decrypt.</p>
      <input type="password" id="passphraseInput" placeholder="Enter passphrase" style="width:100%; padding:12px 16px; border:1px solid rgba(255,255,255,0.1); background:rgba(0,0,0,0.3); border-radius:8px; color:white; font-size:14px; margin-bottom:12px;">
      <p id="passphraseError" style="color:#ef4444; font-size:12px; margin-bottom:12px; display:none;"></p>
      <div style="display:flex; gap:12px;">
        <button id="passphraseSubmit" style="flex:1; padding:12px; background:#818cf8; border:none; border-radius:8px; color:white; font-weight:500; cursor:pointer;">Unlock</button>
        <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#71717a; cursor:pointer;">
          <input type="checkbox" id="rememberPassphrase" checked> Remember
        </label>
      </div>
    </div>
  </div>

  <script>
    let data = null;
    let selected = null;
    let hovered = null;

    const urgencyColor = u => u >= 80 ? ['rgba(239,68,68,0.2)', '#ef4444'] : u >= 60 ? ['rgba(251,191,36,0.2)', '#fbbf24'] : ['rgba(34,197,94,0.2)', '#22c55e'];
    const feasColor = f => f >= 80 ? ['rgba(34,197,94,0.2)', '#22c55e'] : f >= 60 ? ['rgba(251,191,36,0.2)', '#fbbf24'] : ['rgba(239,68,68,0.2)', '#ef4444'];

    function render() {
      if (!data) return;
      const objs = [...data.objectives].sort((a, b) => b.urgency - a.urgency);
      // Sort deliverables: active by feasibility desc, then completed at bottom
      const dels = [...data.deliverables].sort((a, b) => {
        if (a.completed && !b.completed) return 1;
        if (!a.completed && b.completed) return -1;
        return b.feasibility - a.feasibility;
      });

      const linkedIds = new Set();
      if (hovered || selected) {
        const item = hovered || selected;
        linkedIds.add(item.id);
        (item.linkedDeliverables || []).forEach(id => linkedIds.add(id));
        (item.linkedObjectives || []).forEach(id => linkedIds.add(id));
      }
      const anyActive = hovered || selected;

      document.getElementById('objectives').innerHTML = objs.map(o => {
        const [bg, border] = urgencyColor(o.urgency);
        const dimmed = anyActive && !linkedIds.has(o.id) ? 'dimmed' : '';
        const sel = selected?.id === o.id ? 'selected' : '';
        return `<div class="bubble ${dimmed} ${sel}" data-id="${o.id}" style="background:${bg};border:2px solid ${sel ? '#818cf8' : border}">
          <div class="bubble-header"><span class="bubble-title">${o.title}</span><span class="bubble-badge" style="background:${border}">${o.urgency}%</span></div>
          <p class="bubble-desc">${o.description}</p>
          ${o.deadline ? `<p class="bubble-meta">Deadline: ${o.deadline}</p>` : ''}
        </div>`;
      }).join('');

      document.getElementById('deliverables').innerHTML = dels.map(d => {
        const isCompleted = d.completed;
        const [bg, border] = isCompleted ? ['rgba(100,100,100,0.1)', '#555'] : feasColor(d.feasibility);
        const dimmed = anyActive && !linkedIds.has(d.id) ? 'dimmed' : '';
        const sel = selected?.id === d.id ? 'selected' : '';
        const completedClass = isCompleted ? 'completed' : '';
        return `<div class="bubble ${dimmed} ${sel} ${completedClass}" data-id="${d.id}" style="background:${bg};border:2px solid ${sel ? '#818cf8' : border};${isCompleted ? 'opacity:0.5;' : ''}">
          <div class="bubble-header">
            <span class="bubble-title" style="${isCompleted ? 'text-decoration:line-through;' : ''}">${d.title}</span>
            ${isCompleted ? '<span class="bubble-badge" style="background:#22c55e;">Done</span>' : `<span class="bubble-badge" style="background:${border}">${d.feasibility}%</span>`}
          </div>
          <p class="bubble-desc">${d.description}</p>
          ${d.blockers?.length && !isCompleted ? `<p class="bubble-meta bubble-blocker">Blocked by: ${d.blockers.length} item(s)</p>` : ''}
        </div>`;
      }).join('');

      drawLines();
    }

    function drawLines() {
      const svg = document.getElementById('svg-container');
      const main = document.getElementById('main');
      const rect = main.getBoundingClientRect();
      svg.innerHTML = `<defs><linearGradient id="lineGrad" x1="0%" x2="100%"><stop offset="0%" stop-color="#818cf8" stop-opacity="0.6"/><stop offset="100%" stop-color="#c084fc" stop-opacity="0.6"/></linearGradient><linearGradient id="lineGradHL" x1="0%" x2="100%"><stop offset="0%" stop-color="#818cf8"/><stop offset="100%" stop-color="#c084fc"/></linearGradient></defs>`;

      const linkedIds = new Set();
      if (hovered || selected) {
        const item = hovered || selected;
        linkedIds.add(item.id);
        (item.linkedDeliverables || []).forEach(id => linkedIds.add(id));
        (item.linkedObjectives || []).forEach(id => linkedIds.add(id));
      }
      const anyActive = hovered || selected;

      data.objectives.forEach(obj => {
        (obj.linkedDeliverables || []).forEach(delId => {
          const objEl = document.querySelector(`[data-id="${obj.id}"]`);
          const delEl = document.querySelector(`[data-id="${delId}"]`);
          if (!objEl || !delEl) return;
          const oR = objEl.getBoundingClientRect();
          const dR = delEl.getBoundingClientRect();
          const x1 = oR.right - rect.left, y1 = oR.top + oR.height/2 - rect.top;
          const x2 = dR.left - rect.left, y2 = dR.top + dR.height/2 - rect.top;
          const mx = (x1 + x2) / 2;
          const hl = linkedIds.has(obj.id) || linkedIds.has(delId);
          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('d', `M${x1},${y1} C${mx},${y1} ${mx},${y2} ${x2},${y2}`);
          path.setAttribute('fill', 'none');
          path.setAttribute('stroke', hl ? 'url(#lineGradHL)' : 'url(#lineGrad)');
          path.setAttribute('stroke-width', hl ? 3 : 1.5);
          path.setAttribute('opacity', hl ? 1 : anyActive ? 0.15 : 0.4);
          svg.appendChild(path);
        });
      });
    }

    // Use event delegation instead of binding on each render
    function setupEventDelegation() {
      const main = document.getElementById('main');

      main.addEventListener('mouseenter', (e) => {
        const bubble = e.target.closest('.bubble');
        if (bubble) {
          hovered = findItem(bubble.dataset.id);
          render();
        }
      }, true);

      main.addEventListener('mouseleave', (e) => {
        const bubble = e.target.closest('.bubble');
        if (bubble) {
          hovered = null;
          render();
        }
      }, true);

      main.addEventListener('click', (e) => {
        const bubble = e.target.closest('.bubble');
        console.log('Click detected', bubble, e.target);
        if (bubble) {
          const item = findItem(bubble.dataset.id);
          console.log('Found item:', item);
          if (!item) return;
          selected = selected?.id === item.id ? null : item;
          console.log('Selected:', selected);
          showPanel();
          render();
        }
      });

      main.addEventListener('dblclick', (e) => {
        const bubble = e.target.closest('.bubble');
        if (bubble) {
          const item = findItem(bubble.dataset.id);
          if (item.id.startsWith('del-')) {
            completeDeliverable(item, bubble);
          } else {
            showCompleteObjectiveModal(item);
          }
        }
      });
    }

    function findItem(id) {
      if (!data) return null;
      return data.objectives.find(o => o.id === id) || data.deliverables.find(d => d.id === id);
    }

    // Confetti animation
    function showConfetti(element) {
      const rect = element.getBoundingClientRect();
      const colors = ['#818cf8', '#c084fc', '#22c55e', '#fbbf24', '#ef4444'];

      for (let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
          position: fixed;
          width: 10px;
          height: 10px;
          background: ${colors[Math.floor(Math.random() * colors.length)]};
          left: ${rect.left + rect.width / 2}px;
          top: ${rect.top + rect.height / 2}px;
          pointer-events: none;
          border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
          z-index: 1000;
        `;
        document.body.appendChild(confetti);

        const angle = (Math.random() * 360) * (Math.PI / 180);
        const velocity = 5 + Math.random() * 10;
        const vx = Math.cos(angle) * velocity;
        const vy = Math.sin(angle) * velocity;

        let x = 0, y = 0, opacity = 1;
        const animate = () => {
          x += vx;
          y += vy + 2; // gravity
          opacity -= 0.02;
          confetti.style.transform = `translate(${x}px, ${y}px) rotate(${x * 5}deg)`;
          confetti.style.opacity = opacity;
          if (opacity > 0) {
            requestAnimationFrame(animate);
          } else {
            confetti.remove();
          }
        };
        requestAnimationFrame(animate);
      }
    }

    async function completeDeliverable(item, element) {
      showConfetti(element);

      // Mark as completed (moves to bottom)
      item.completed = true;
      data.lastUpdated = new Date().toISOString();

      // Save to server
      const passphrase = getStoredPassphrase();
      try {
        await fetch('/api/data', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data, passphrase })
        });
      } catch (e) {
        console.error('Failed to save:', e);
      }

      render();
    }

    function showCompleteObjectiveModal(objective) {
      const confirmed = confirm(`Mark "${objective.title}" as complete?\n\nThis will also remove any deliverables that are only connected to this objective.`);
      if (confirmed) {
        completeObjective(objective);
      }
    }

    async function completeObjective(objective) {
      // Find deliverables that will become orphaned
      const orphanedDels = data.deliverables.filter(d => {
        const linkedObjs = d.linkedObjectives || [];
        // Only linked to this objective
        return linkedObjs.length === 1 && linkedObjs[0] === objective.id;
      });

      // Remove the objective
      data.objectives = data.objectives.filter(o => o.id !== objective.id);

      // Remove orphaned deliverables
      orphanedDels.forEach(d => {
        data.deliverables = data.deliverables.filter(del => del.id !== d.id);
        // Clean up relationships
        Object.keys(data.relationships).forEach(k => {
          if (k.endsWith(`:${d.id}`)) delete data.relationships[k];
        });
      });

      // Clean up relationships for the objective
      Object.keys(data.relationships).forEach(k => {
        if (k.startsWith(`${objective.id}:`)) delete data.relationships[k];
      });

      // Update remaining deliverables to remove this objective from their links
      data.deliverables.forEach(d => {
        d.linkedObjectives = (d.linkedObjectives || []).filter(id => id !== objective.id);
      });

      data.lastUpdated = new Date().toISOString();

      // Save to server
      const passphrase = getStoredPassphrase();
      try {
        await fetch('/api/data', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data, passphrase })
        });
      } catch (e) {
        console.error('Failed to save:', e);
      }

      selected = null;
      showPanel();
      render();
    }

    function showPanel() {
      const panel = document.getElementById('panel');
      if (!selected) { panel.classList.remove('open'); return; }
      panel.classList.add('open');

      const isObj = selected.id.startsWith('obj');
      document.getElementById('panelType').textContent = isObj ? 'Objective' : 'Deliverable';
      document.getElementById('panelType').style.color = isObj ? '#818cf8' : '#c084fc';
      document.getElementById('panelTitle').textContent = selected.title;
      document.getElementById('panelDesc').textContent = selected.description;

      const linkedIds = isObj ? selected.linkedDeliverables : selected.linkedObjectives;
      const linkedItems = isObj
        ? data.deliverables.filter(d => linkedIds?.includes(d.id))
        : data.objectives.filter(o => linkedIds?.includes(o.id));

      document.getElementById('relationships').innerHTML = linkedItems.map(linked => {
        const key = isObj ? `${selected.id}:${linked.id}` : `${linked.id}:${selected.id}`;
        const rel = data.relationships[key] || 'Relationship pending...';
        return `<div class="relationship">
          <div class="relationship-header">
            <span class="relationship-type" style="color:${isObj ? '#c084fc' : '#818cf8'}">${isObj ? 'Deliverable' : 'Objective'}:</span>
            <span class="relationship-name">${linked.title}</span>
          </div>
          <p class="relationship-text">${rel}</p>
        </div>`;
      }).join('');
    }

    document.getElementById('panelClose').addEventListener('click', () => { selected = null; showPanel(); render(); });
    document.getElementById('logout').addEventListener('click', async (e) => {
      e.preventDefault();
      await fetch('/auth/logout', { method: 'POST' });
      window.location.href = '/';
    });

    // Passphrase handling
    let evtSource = null;
    let pendingPassphrase = null; // Track passphrase being tested
    const PASSPHRASE_KEY = 'cosimo_passphrase';

    function getStoredPassphrase() {
      return localStorage.getItem(PASSPHRASE_KEY) || sessionStorage.getItem(PASSPHRASE_KEY);
    }

    function storePassphrase(passphrase, remember) {
      if (remember) {
        localStorage.setItem(PASSPHRASE_KEY, passphrase);
      } else {
        sessionStorage.setItem(PASSPHRASE_KEY, passphrase);
      }
    }

    function clearStoredPassphrase() {
      localStorage.removeItem(PASSPHRASE_KEY);
      sessionStorage.removeItem(PASSPHRASE_KEY);
    }

    function showPassphraseModal() {
      const modal = document.getElementById('passphraseModal');
      modal.style.display = 'flex';
      document.getElementById('passphraseInput').focus();
    }

    function hidePassphraseModal() {
      document.getElementById('passphraseModal').style.display = 'none';
      document.getElementById('passphraseInput').value = '';
      document.getElementById('passphraseError').style.display = 'none';
    }

    function showPassphraseError(msg) {
      const errorEl = document.getElementById('passphraseError');
      errorEl.textContent = msg;
      errorEl.style.display = 'block';
    }

    async function connectStream(passphrase = null) {
      // Close existing connection
      if (evtSource) {
        evtSource.close();
      }

      pendingPassphrase = passphrase;
      const url = passphrase ? `/api/stream?passphrase=${encodeURIComponent(passphrase)}` : '/api/stream';

      document.getElementById('statusDot').style.background = '#fbbf24';
      document.getElementById('statusText').textContent = 'Connecting...';

      evtSource = new EventSource(url);

      evtSource.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        data = msg.data;
        pendingPassphrase = null;
        document.getElementById('statusDot').style.background = '#22c55e';
        document.getElementById('statusText').textContent = 'Synced';
        hidePassphraseModal();
        render();
      };

      evtSource.onerror = () => {
        evtSource.close();

        // If we were testing a passphrase and it failed, show error
        if (pendingPassphrase) {
          clearStoredPassphrase();
          document.getElementById('statusDot').style.background = '#fbbf24';
          document.getElementById('statusText').textContent = 'Locked';
          showPassphraseError('Invalid passphrase. Please try again.');
          showPassphraseModal();
          pendingPassphrase = null;
        } else {
          document.getElementById('statusDot').style.background = '#ef4444';
          document.getElementById('statusText').textContent = 'Disconnected';
        }
      };
    }

    // Check if encryption is enabled and prompt for passphrase if needed
    async function initConnection() {
      try {
        const res = await fetch('/auth/me');
        if (!res.ok) {
          window.location.href = '/';
          return;
        }
        const user = await res.json();

        if (user.encryption_enabled) {
          const storedPassphrase = getStoredPassphrase();
          if (storedPassphrase) {
            // Try with stored passphrase
            connectStream(storedPassphrase);
          } else {
            // Need to prompt for passphrase
            document.getElementById('statusDot').style.background = '#fbbf24';
            document.getElementById('statusText').textContent = 'Locked';
            showPassphraseModal();
          }
        } else {
          // No encryption, connect directly
          connectStream(null);
        }
      } catch (e) {
        document.getElementById('statusDot').style.background = '#ef4444';
        document.getElementById('statusText').textContent = 'Error';
      }
    }

    // Passphrase modal handlers
    document.getElementById('passphraseSubmit').addEventListener('click', () => {
      const passphrase = document.getElementById('passphraseInput').value;
      const remember = document.getElementById('rememberPassphrase').checked;

      if (!passphrase) {
        showPassphraseError('Please enter your passphrase');
        return;
      }

      storePassphrase(passphrase, remember);
      connectStream(passphrase);
    });

    document.getElementById('passphraseInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('passphraseSubmit').click();
      }
    });

    // Setup event delegation once
    setupEventDelegation();

    // Clear hover when mouse leaves main area entirely
    document.getElementById('main').addEventListener('mouseleave', () => {
      if (hovered) {
        hovered = null;
        render();
      }
    });

    // Initial connection
    initConnection();

    window.addEventListener('resize', () => data && drawLines());
  </script>
</body>
</html>
